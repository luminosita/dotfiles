version: '3'

vars:
  RED: '\033[0;31m'
  GREEN: '\033[0;32m'
  YELLOW: '\033[1;33m'
  NC: '\033[0m'  # No Color

tasks:
  folders:nu-shell:
    internal: true
    silent: true
    dir: '{{.USER_WORKING_DIR}}'
    cmds:
      - mkdir -p cmd lib

  symlinks:nu-shell:
    internal: true
    silent: true
    dir: '{{.USER_WORKING_DIR}}'
    deps:
      - folders:nu-shell
    cmds:
      - ln -sf ../../nu-shared/cmd/build.nu cmd/build.nu
      - ln -sf ../../nu-shared/lib lib/shared
      - ln -sf ../nu-shared/CLAUDE-nushell.md .
      - ln -sf ../nu-shared/.pre-commit-config.yaml .
      - ln -sf ../nu-shared/.mcp.json .

  taskfile:nu-shell:
    internal: true
    silent: true
    dir: '{{.USER_WORKING_DIR}}'
    deps:
      - folders:nu-shell
    cmds:
      - |
        if [ ! -f Taskfile.yml ]; then
          cat > Taskfile.yml <<EOF
        version: '3'

        includes:
          main:
            taskfile: "$HOME/.taskfile/Taskfile.main.yml"
            excludes: [check, build:assembly]
            flatten: true
          nu-shell:
            taskfile: "$HOME/.taskfile/Taskfile.nushell.yml"
            excludes: []
            flatten: true
        EOF
          echo "✅ Taskfile.yml created"
        else
          echo "ℹ️  Taskfile.yml already exists, skipping creation"
        fi

  version-file:
    silent: true
    internal: true
    dir: '{{.USER_WORKING_DIR}}'
    deps:
    cmds:
      - |
        if [ ! -f VERSION ]; then
          cat > VERSION <<EOF
        0.0.1
        EOF
          echo "✅ Version file created"
        else
          echo "ℹ️  Version file already exists, skipping creation"
        fi

# ====================
# Misc
# ====================
  environment:nushell:
    silent: true
    dir: '{{.USER_WORKING_DIR}}'
    deps:
      - symlinks:nu-shell
      - taskfile:nu-shell      
      - version-file
      - echo "✅ NuShell environment ready !"

  default:
    silent: true
    dir: '{{.USER_WORKING_DIR}}'
    desc: Show available tasks
    cmds:
      - 'echo -e "{{.YELLOW}}Current working dir: $(pwd){{.NC}}"'
      - task -a
