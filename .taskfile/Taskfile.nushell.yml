version: '3'

# Setup Script - Development Tasks
# Consolidated CLI interface for all development operations

tasks:
  check:
    desc: Run pre-commit checks (tests and linting)
    deps:
      - check:devbox
    cmds:
      - task: test:verbose
      - task: hooks:run

  build:
    desc: "Build standalone setup script and container images"
    silent: true
    deps:
      - task: build:assembly

  build:scripts:
    desc: "Build standalone setup script (all languages)"
    deps:
      - check:devbox
    silent: true
    internal: true 
    cmds:
      - rm -rf dist && mkdir -p dist
      - for: { var: SCRIPTS }
        cmd: |
          echo "Building {{.ITEM}}..."
          nu cmd/build.nu --yes --main-script cmd/{{.ITEM}} --output dist/{{.ITEM}}

  build:assembly:
    desc: "Build standalone setup script and container images"
    silent: true
    deps:
      - task: build:scripts
        vars:
          SCRIPTS: ['setup.nu']
    cmds:
      - |
        mkdir -p dist/default/assembly
        cp dist/setup.nu dist/default/setup.nu

  # ====================
  # Tests
  # ====================

  test:
    desc: Run all unit tests with summary reporting
    cmds:
      - task: test:unit 

  test:verbose:
    desc: Run all unit tests with detailed assertion reporting
    cmds:
      - task: test
        vars:
          CLI_ARGS: "--verbose {{.CLI_ARGS}}"

  test:unit:
    desc: Run unit tests only with summary reporting
    deps:
      - check:devbox
    cmds:
      - nu lib/shared/test.nu --unit {{.CLI_ARGS}}

  test:unit:verbose:
    desc: Run unit tests only with detailed assertion reporting
    cmds:
      - task: test:unit
        vars:
          CLI_ARGS: "--verbose {{.CLI_ARGS}}"

  # ====================
  # Integration Tests
  # ====================

  test:integration:
    desc: Run only previously failed tests
    cmds:
      - nu lib/shared/test.nu --integration {{.CLI_ARGS}}

  test:integration:verbose:
    desc: Run only previously failed tests with detailed reporting
    cmds:
      - task: test:integration
        vars:
          CLI_ARGS: "--verbose {{.CLI_ARGS}}"

  test:integration:cluster:
    cmds:
      - task: test:kind:start
      - defer: { task: test:kind:stop }
      - task: test:integration
        vars:
          CLI_ARGS: "{{.CLI_ARGS}}"

  test:integration:cluster:verbose:
    desc: Run integration tests with verbose output (create → test → teardown) | Pass extra args with -- (e.g., task test:integration:verbose -- --failed)
    cmds:
      - task: test:integration:cluster
        vars:
          CLI_ARGS: "--verbose {{.CLI_ARGS}}"

  # ====================
  # Failed Tests
  # ====================

  test:failed:
    desc: Run only previously failed tests
    cmds:
      - nu lib/shared/test.nu --failed {{.CLI_ARGS}}

  test:failed:verbose:
    desc: Run only previously failed tests with detailed reporting
    cmds:
      - task: test:failed
        vars:
          CLI_ARGS: "--verbose {{.CLI_ARGS}}"

  test:failed:cluster:
    desc: Run end-to-end tests with cluster lifecycle (build → create → test → teardown) | Pass extra args with -- (e.g., task test:e2e -- --failed)
    cmds:
      - task: test:kind:start
      - defer: { task: test:kind:stop }
      - task: test:failed
        vars:
          CLI_ARGS: "{{.CLI_ARGS}}"

  test:failed:cluster:verbose:
    desc: Run end-to-end tests with verbose output (build → create → test → teardown) | Pass extra args with -- (e.g., task test:e2e:verbose -- --failed)
    cmds:
      - task: test:failed:cluster
        vars:
          CLI_ARGS: "--verbose {{.CLI_ARGS}}"


  # ====================
  # E2E Tests
  # ====================

  test:e2e:
    desc: Run end-to-end tests with verbose output (build → create → test → teardown) | Pass extra args with -- (e.g., task test:e2e:verbose -- --failed)
    deps:
      - task: release:snapshot:package
    cmds:
      - nu lib/shared/test.nu --e2e {{.CLI_ARGS}}

  test:e2e:verbose:
    desc: Run end-to-end tests with cluster lifecycle (build → create → test → teardown) | Pass extra args with -- (e.g., task test:e2e -- --failed)
    cmds:
      - task: test:e2e
        vars:
          CLI_ARGS: "--verbose {{.CLI_ARGS}}"

  test:e2e:cluster:
    desc: Run end-to-end tests with cluster lifecycle (build → create → test → teardown) | Pass extra args with -- (e.g., task test:e2e -- --failed)
    cmds:
      - task: test:kind:start
      - defer: { task: test:kind:stop }
      - task: test:e2e
        vars:
          CLI_ARGS: "{{.CLI_ARGS}}"

  test:e2e:cluster:verbose:
    desc: Run end-to-end tests with verbose output (build → create → test → teardown) | Pass extra args with -- (e.g., task test:e2e:verbose -- --failed)
    cmds:
      - task: test:e2e:cluster
        vars:
          CLI_ARGS: "--verbose {{.CLI_ARGS}}"
